# 设备管理员 (BIND_DEVICE_ADMIN) 使用说明

## 概述

`android.permission.BIND_DEVICE_ADMIN` 是一个**签名权限**，用于将应用注册为设备管理员。设备管理员可以执行一些高级设备管理操作，如锁定屏幕、清除数据、重置密码等。

## 配置步骤

### 1. AndroidManifest.xml 配置

已在 `AndroidManifest.xml` 中配置：

```xml
<receiver
    android:name=".receiver.PolicyReceiver"
    android:description="@string/app_description"
    android:label="@string/app_name"
    android:permission="android.permission.BIND_DEVICE_ADMIN">
    <meta-data
        android:name="android.app.device_admin"
        android:resource="@xml/policy" />
    <intent-filter>
        <action android:name="android.app.action.DEVICE_ADMIN_ENABLED" />
    </intent-filter>
</receiver>
```

**关键点：**
- `android:permission="android.permission.BIND_DEVICE_ADMIN"` - 声明使用设备管理员权限
- `meta-data` 指向 `@xml/policy` - 定义设备管理员策略

### 2. policy.xml 配置

在 `res/xml/policy.xml` 中定义可用的策略：

```xml
<device-admin xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-policies>
        <limit-password />      <!-- 限制密码策略 -->
        <watch-login />          <!-- 监控登录尝试 -->
        <reset-password />       <!-- 重置密码 -->
        <force-lock />           <!-- 强制锁定屏幕 -->
        <wipe-data />            <!-- 清除设备数据 -->
    </uses-policies>
</device-admin>
```

### 3. DeviceAdminReceiver 实现

`PolicyReceiver` 继承自 `DeviceAdminReceiver`，处理设备管理员相关事件。

## 使用方法

### 基本使用

#### 1. 检查设备管理员状态

```java
boolean isActive = DeviceAdminHelper.isDeviceAdminActive(context);
if (isActive) {
    // 设备管理员已激活
} else {
    // 需要激活设备管理员
}
```

#### 2. 激活设备管理员

在 Activity 中激活（需要用户确认）：

```java
// 在 Activity 中
private static final int REQUEST_CODE_ENABLE_ADMIN = 1000;

// 激活设备管理员
DeviceAdminHelper.activateDeviceAdmin(this, REQUEST_CODE_ENABLE_ADMIN);

// 处理结果
@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    if (requestCode == REQUEST_CODE_ENABLE_ADMIN) {
        if (resultCode == RESULT_OK) {
            Toast.makeText(this, "设备管理员已激活", Toast.LENGTH_SHORT).show();
        } else {
            Toast.makeText(this, "用户取消了激活", Toast.LENGTH_SHORT).show();
        }
    }
}
```

#### 3. 锁定屏幕

```java
if (DeviceAdminHelper.lockNow(context)) {
    // 屏幕已锁定
}
```

#### 4. 禁用设备管理员

```java
DeviceAdminHelper.deactivateDeviceAdmin(context);
```

### 高级功能

#### 重置密码

```java
// 需要 policy.xml 中声明 <reset-password />
boolean success = DeviceAdminHelper.resetPassword(context, "新密码");
```

#### 设置密码质量要求

```java
// 密码质量常量：
// DevicePolicyManager.PASSWORD_QUALITY_ALPHABETIC - 字母
// DevicePolicyManager.PASSWORD_QUALITY_ALPHANUMERIC - 字母数字
// DevicePolicyManager.PASSWORD_QUALITY_NUMERIC - 数字
// DevicePolicyManager.PASSWORD_QUALITY_SOMETHING - 任意
// DevicePolicyManager.PASSWORD_QUALITY_UNSPECIFIED - 无要求

DeviceAdminHelper.setPasswordQuality(context, 
    DevicePolicyManager.PASSWORD_QUALITY_ALPHANUMERIC);
```

## 注意事项

1. **签名权限**：`BIND_DEVICE_ADMIN` 是签名权限，只有系统应用或使用系统签名的应用才能使用。普通应用无法使用此权限。

2. **用户确认**：激活设备管理员需要用户明确同意，系统会弹出对话框。

3. **权限限制**：某些功能（如清除数据）需要用户在 `policy.xml` 中明确声明对应的策略。

4. **安全警告**：
   - `wipeData()` 会清除所有用户数据，请谨慎使用
   - 设备管理员权限非常强大，请确保应用的安全性

5. **测试限制**：在非系统应用中，某些功能可能无法正常工作，因为需要系统签名。

## 常见问题

### Q: 为什么我的应用无法使用设备管理员功能？

A: `BIND_DEVICE_ADMIN` 是签名权限，只有系统应用才能使用。普通应用需要：
- 使用系统签名
- 或者作为系统应用安装（需要 root 权限）

### Q: 如何测试设备管理员功能？

A: 在开发环境中，可以：
1. 使用系统镜像进行测试
2. 在已 root 的设备上安装为系统应用
3. 使用 Android 模拟器（某些功能可能受限）

### Q: 设备管理员激活后如何取消？

A: 用户可以在"设置 > 安全 > 设备管理器"中取消激活，或者调用 `deactivateDeviceAdmin()` 方法。

## 完整示例

```java
public class MainActivity extends AppCompatActivity {
    private static final int REQUEST_CODE_ENABLE_ADMIN = 1000;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        // 检查设备管理员状态
        if (!DeviceAdminHelper.isDeviceAdminActive(this)) {
            // 激活设备管理员
            DeviceAdminHelper.activateDeviceAdmin(this, REQUEST_CODE_ENABLE_ADMIN);
        }
    }
    
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == REQUEST_CODE_ENABLE_ADMIN) {
            if (resultCode == RESULT_OK) {
                // 激活成功，可以使用设备管理员功能
                Toast.makeText(this, "设备管理员已激活", Toast.LENGTH_SHORT).show();
            }
        }
    }
    
    // 锁定屏幕示例
    private void lockScreen() {
        if (DeviceAdminHelper.lockNow(this)) {
            Toast.makeText(this, "屏幕已锁定", Toast.LENGTH_SHORT).show();
        }
    }
}
```

